<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send OTP</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <div id="loader" class="loader" style="display:none;">Loading...</div>
    <div id="errorBox" class="error-box"></div>
    <div id="ok" class="ok"></div>

    <h2>Send OTP & Verify OTP</h2> 
    <input type="text" id="otp_email" placeholder="Email">
    <button id="send_1otp">Send OTP</button>

    <input type="text" id="otp_code" placeholder="Enter OTP">
    <button id="verify_btn">Verify</button>
</div>

<script>
 const url = "https://simp-api.dev.crymzee.com/api/";
 const otp_type = "forgot";
   if (pendingData.email) {
    document.getElementById("otp_email").value = pendingData.email;
  }

  function showLoader(show) {
    document.getElementById("loader").style.display = show ? "block" : "none";
  }
  function showError(message) {
    const box = document.getElementById("errorBox");
    box.innerText = message;
    box.style.display = "block";
    setTimeout(() => box.style.display = "none", 5000);
  }
  function ShowOK(message) {
    const box = document.getElementById("ok");
    box.innerText = message;
    box.style.display = "block";
    setTimeout(() => box.style.display = "none", 5000);
  }

  document.getElementById("send_1otp").addEventListener("click", async () => {
    if (!otp_email.value.trim()) return showError("Enter Address first.");
    Send_OTP(otp_email.value.trim(), "create");
  });

  document.getElementById("verify_btn").addEventListener("click", async () => {
    if (!otp_code.value.trim()) return showError("Enter OTP first.");
    OTP_VERIFY(otp_email.value.trim(), otp_code.value.trim(), "create");
  });

  async function Send_OTP(email, otp_type) {
    showLoader(true);
    try {
      const res = await fetch(`${url}otp/send`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, otp_type, role: "user" }),
      });
      const data = await res.json();
      if (res.ok) ShowOK("OTP sent successfully.");
      else showError(data.message || "Failed to send OTP.");
    } catch {
      showError("Error sending OTP.");
    } finally {
      showLoader(false);
    }
  }

  async function OTP_VERIFY(Email, OTP, otp_type) {
    showLoader(true);
    try {
      const res = await fetch(`${url}otp/verify`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: Email, otp_code: OTP, otp_type, role: "user" }),
      });
      const data = await res.json();
      if (res.ok) {
        const registerToken = data.verification_token;
        ShowOK("OTP verified. Registering account...");

        const imageBlob = await fetch(pendingData.image_base64).then(res => res.blob());
        const imageFile = new File([imageBlob], "profile.jpg", { type: imageBlob.type });

        const formData = new FormData();
        formData.append("role", "user");
        formData.append("email", pendingData.email);
        formData.append("phone_number", pendingData.phone);
        formData.append("password", pendingData.password);
        formData.append("confirm_password", pendingData.confirm_password);
        formData.append("verification_token", registerToken);
        formData.append("username", pendingData.username);
        formData.append("first_name", pendingData.first_name);
        formData.append("last_name", pendingData.last_name);
        formData.append("image", imageFile);

        const registerRes = await fetch(`${url}register`, { method: "POST", body: formData });
        const registerData = await registerRes.json();

        if (registerRes.ok) {
          ShowOK("Registered successfully. Redirecting to login...");
          localStorage.removeItem("pendingRegisterData");
          setTimeout(() => window.location.href = "login.html", 3000);
        } else {
          showError(registerData.message || "Registration failed.");
        }
      } else {
        showError(data.message || "Failed to verify OTP.");
      }
    } catch {
      showError("Error verifying OTP.");
    } finally {
      showLoader(false);
    }
  }
</script>
</body>
</html>